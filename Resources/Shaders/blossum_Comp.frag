#version 450
layout(location=0) in vec4 v2f_ObjectPos;layout(location=1) in vec2 v2f_UV;layout(location=0) out vec4 gPosition;layout(location=1) out vec4 gNormal;layout(location=2) out vec4 gAlbedo;layout(location=3) out vec4 gDepth;layout(location=4) out vec4 gParam_1;
layout(binding = 1) uniform FragUniformBufferObject{mat4 invModel;mat4 model;mat4 view;mat4 proj;vec4 cameraPos;vec4 mainColor;vec4 placeCubeSize;vec4 v4Pad2;vec2 resolution;float time;float deltaTime;float zLength;float LightParam;float useZAnim;float fPad1;float fPad2;} fragUbo;
#define repeat(p,a)mod(p,a)-a*0.5
#define rot(a)mat2(cos(a),sin(a),-sin(a),cos(a))
#define pi acos(-1.0)
#define pi2 pi*2.0
struct MatInfo{float d;float MatID;float metallic;float roughness;};MatInfo v(MatInfo o,float v,float f,float d,float a){if(v<o.d)o.d=v,o.MatID=f,o.metallic=d,o.roughness=a;return o;}float v(vec3 v,vec3 a){return length(max(vec3(0),abs(v)-a));}float t(vec3 v,vec2 o){return length(vec2(length(v.xz)-o.x,v.y))-o.y;}MatInfo f(vec3 o,vec3 a){MatInfo f;f.d=1e5;f.MatID=-1;f.metallic=0.;f.roughness=0.;o+=a;float l=1e5;o.y+=2.;if(length(o.xz-fragUbo.cameraPos.xz)>15.)return f;if(floor(fragUbo.useZAnim)==1.)o.z+=fragUbo.time;vec2 n=floor(o.xz/4.)*4.;o.xz=repeat(o.xz,4.);for(float d=0.;d<3.;d++){vec3 s=o;s.xz*=rot(pi*(1./3.)*d);s.yz*=rot(pi*.5);vec3 p=s;s.x=abs(s.x)-.25;vec3 D=vec3(0,0,.1);s-=clamp(s,-D,D);float y=t(s,vec2(.25,.00025+.02*length(o.y)));l=min(l,y);{float g=mod(fragUbo.time+(fract(sin(dot(vec2(n.xy*10.+a.xz*10.),vec2(12.9898,78.233)))*43758.5453123)*2.-1.)*5e2,5e2);g=sin(step(g,493.717)*(g-493.717))*.5+.5;l=max(l,v(p,vec3(.75*g,.75*g,.75*g)));}{float g=v(o-vec3(0,.25,0),vec3(.75,.25,.75));l=max(l,g);}f=v(f,l,4.,.25,1.);}return f;}MatInfo f(vec3 a){MatInfo o;o.d=1e5;o.MatID=-1;o.metallic=0.;o.roughness=0.;{MatInfo n=f(a,vec3(0));o=v(o,n.d,n.MatID,n.metallic,n.roughness);}{MatInfo n=f(a,vec3(2,0,2));o=v(o,n.d,n.MatID,n.metallic,n.roughness);}return o;}vec3 t(vec3 v){vec2 o=vec2(.001,0);return normalize(vec3(f(v+o.xyy).d-f(v-o.xyy).d,f(v+o.yxy).d-f(v-o.yxy).d,f(v+o.yyx).d-f(v-o.yyx).d));}float v(vec3 v){vec4 o=fragUbo.proj*fragUbo.view*vec4(v,1);float f=o.z/o.w*.5+.5,n=f*f,l=dFdx(f);f=dFdy(f);return n+.25*(l*l+f*f);}void main(){vec3 o=vec3(0);vec2 n=v2f_UV*2.-1.;n.x*=fragUbo.resolution.x/fragUbo.resolution.y;vec3 a=(fragUbo.invModel*fragUbo.cameraPos).xyz,l=normalize(v2f_ObjectPos.xyz-a);a+=fragUbo.cameraPos.xyz;float g=0.;vec3 d=a+l*g;MatInfo s;s.d=1e5;s.MatID=-1;s.metallic=0.;s.roughness=0.;for(int o=0;o<64;o++){s=f(d);g+=s.d;d=a+l*g;if(abs(s.d)<.001)break;}if(s.d<.001){vec3 l=t(d);float a=v(d);o=vec3(1);if(s.MatID==4.)o=fragUbo.mainColor.xyz*3.;gPosition=vec4(d,1);gNormal=vec4(l,1);gAlbedo=vec4(o,1);gDepth=vec4(vec3(a),1);gParam_1=vec4(s.MatID,fragUbo.LightParam,s.metallic,s.roughness);gl_FragDepth=a;}else discard;}