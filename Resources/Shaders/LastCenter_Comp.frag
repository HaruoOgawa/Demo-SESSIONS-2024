#version 450
layout(location=0) in vec4 v2f_ObjectPos;layout(location=1) in vec2 v2f_UV;layout(location=0) out vec4 gPosition;layout(location=1) out vec4 gNormal;layout(location=2) out vec4 gAlbedo;layout(location=3) out vec4 gDepth;layout(location=4) out vec4 gParam_1;
layout(binding = 1) uniform FragUniformBufferObject{mat4 invModel;mat4 model;mat4 view;mat4 proj;vec4 cameraPos;vec4 mainColor;vec4 objPos;vec4 param1;vec2 resolution;float time;float deltaTime;float zLength;float tparam;float LightParam;float rate;float fPad1;float fPad2;} fragUbo;
#define repeat(p,a)mod(p,a)-a*0.5
#define rot(a)mat2(cos(a),sin(a),-sin(a),cos(a))
#define pi acos(-1.0)
#define pi2 pi*2.0
struct MatInfo{float d;float MatID;float metallic;float roughness;};MatInfo t(MatInfo o,float v){if(v<o.d)o.d=v,o.MatID=4.,o.metallic=.25,o.roughness=1.;return o;}vec2 v(vec2 o,float v){v=pi*2./v;v*=floor((atan(o.x,o.y)+v*.5)/v);return o*rot(-v);}float f(vec3 v,vec3 a){return length(max(vec3(0),abs(v)-a));}MatInfo f(vec3 o){MatInfo l;l.d=1e5;l.MatID=-1;l.metallic=0.;l.roughness=0.;o.y+=1.;o+=fragUbo.objPos.xyz;o.xy*=rot(fragUbo.time);o.yz*=rot(fragUbo.time);o.xz*=rot(fragUbo.time);float a=f(o,vec3(.25));if(fragUbo.rate>0.){o.xy=v(o.xy,8.);o.xz=v(o.xz,3.);float l=floor(fragUbo.time*.25)+pow(fract(fragUbo.time*.25),.15);for(int v=0;v<3;v++){o=abs(o)-.1;if(o.x<o.y)o.xy=o.yx;if(o.x<o.z)o.xz=o.zx;if(o.y<o.z)o.yz=o.zy;o.xy*=rot(l);o.xz*=rot(l);o.xz*=rot(l);}l=f(o,vec3(.1,.75,.1)*.5);a=mix(a,l,fragUbo.rate);}return t(l,a);}vec3 t(vec3 v){vec2 o=vec2(.001,0);return normalize(vec3(f(v+o.xyy).d-f(v-o.xyy).d,f(v+o.yxy).d-f(v-o.yxy).d,f(v+o.yyx).d-f(v-o.yyx).d));}float v(vec3 v){vec4 o=fragUbo.proj*fragUbo.view*vec4(v,1);float l=o.z/o.w*.5+.5,a=l*l,f=dFdx(l);l=dFdy(l);return a+.25*(f*f+l*l);}void main(){vec3 o=vec3(0);vec2 l=v2f_UV*2.-1.;l.x*=fragUbo.resolution.x/fragUbo.resolution.y;vec3 a=(fragUbo.invModel*fragUbo.cameraPos).xyz,n=normalize(v2f_ObjectPos.xyz-a);a+=fragUbo.cameraPos.xyz;float g=0.;vec3 d=a+n*g;MatInfo r;r.d=1e5;r.MatID=-1;r.metallic=0.;r.roughness=0.;int i=0;for(int v=0;v<64;v++){r=f(d);g+=r.d*.5;d=a+n*g;i=v;if(abs(r.d)<.001)break;}if(r.d<.001){vec3 l=t(d);float a=v(d);o=vec3(.615,.8,.88)*10./i;gPosition=vec4(d,1);gNormal=vec4(l,1);gAlbedo=vec4(o,1);gDepth=vec4(vec3(a),1);gParam_1=vec4(r.MatID,0,r.metallic,r.roughness);gl_FragDepth=a;}else discard;}