#version 450
layout(location=0) in vec2 fUV;layout(binding=1) uniform sampler2D texGPosition;layout(binding=3) uniform sampler2D texGNormal;layout(binding=5) uniform sampler2D texGAlbedo;layout(binding=7) uniform sampler2D texDepth;layout(binding=9) uniform sampler2D texParam1;layout(binding=11) uniform sampler2D texSSWGPosition;layout(binding=13) uniform sampler2D texSSWGNormal;layout(binding=15) uniform sampler2D texSSWGAlbedo;layout(binding=17) uniform sampler2D texSSWDepth;layout(binding=19) uniform sampler2D texSSWParam1;layout(binding=21) uniform sampler2D texMainColor;layout(location=0) out vec4 outColor;layout(location=1) out vec4 gPosition;layout(location=2) out vec4 gNormal;layout(location=3) out vec4 gAlbedo;layout(location=4) out vec4 gDepth;layout(location=5) out vec4 gParam_1;
layout(binding = 0) uniform UniformBufferObject{mat4 model;mat4 view;mat4 proj;mat4 lightVPMat;vec4 lightDir;vec4 lightPos;vec4 lightColor;vec4 cameraPos;float Attenuation;float fPad0;float fPad1;float fPad2;} fragUBO;
#define rot(a)mat2(cos(a),sin(a),-sin(a),cos(a))
struct PBRParam{float NdotL;float NdotV;float NdotH;float LdotH;float VdotH;float perceptualRoughness;float metallic;vec3 reflectance0;vec3 reflectance90;float alphaRoughness;vec3 diffuseColor;vec3 specularColor;};float t(PBRParam t){float s=t.alphaRoughness*t.alphaRoughness,n=(t.NdotH*s-t.NdotH)*t.NdotH+1.;return s/(acos(-1.)*n*n);}float e(PBRParam t){float s=t.NdotL,n=t.NdotV,a=t.alphaRoughness;return 2.*s/(s+sqrt(a*a+(1.-a*a)*(s*s)))*(2.*n/(n+sqrt(a*a+(1.-a*a)*(n*n))));}vec3 s(PBRParam t){return t.reflectance0+(t.reflectance90-t.reflectance0)*pow(clamp(1.-t.VdotH,0.,1.),5.);}vec3 e(vec3 l,vec3 f,vec3 u,bool a,bool v,vec3 n){float g=0.;vec4 o=vec4(1);float r=1.;g=clamp(g,.04,1.);r=clamp(r,0.,1.);float i=g*g;vec4 c=vec4(l,1);l=vec3(.04);vec3 b=c.xyz*(vec3(1)-l)*(1.-r),z=mix(l,c.xyz,r),d=f;f=-1.f*normalize(u-fragUBO.cameraPos.xyz);l=n;if(a){vec3 t=fragUBO.lightPos.xyz;l=-1.f*normalize(u-t);}n=normalize(f+l);float m=clamp(dot(d,l),0.,1.),h=clamp(abs(dot(d,f)),0.,1.),P=clamp(dot(l,n),0.,1.);PBRParam N=PBRParam(m,h,clamp(dot(d,n),0.,1.),P,clamp(dot(f,n),0.,1.),g,r,z.xyz,vec3(1)*clamp(max(max(z.x,z.y),z.z)*25.,0.,1.),i,b,z);b=vec3(0);z=vec3(0);P=t(N);i=e(N);d=s(N);if(m>0.||h>0.)b=max(b+P*i*d/(4.*m*h),vec3(0)),z+=(1.-d)*(N.diffuseColor/acos(-1.)),o.xyz=m*(b+z);b=clamp(b,.04,1.);o.xyz+=b*z;o.xyz=pow(o.xyz,vec3(1./2.2));if(a){float n=length(u-fragUBO.lightPos.xyz);o.xyz*=exp(-1.*n*.25);}else if(v){float n=length(u-fragUBO.cameraPos.xyz);o.xyz*=exp(-1.*n*.25);}return o.xyz;}void main(){vec2 n=fUV;vec4 t=texture(texDepth,n),z=texture(texSSWDepth,n);if(t.x<=z.x)gPosition=texture(texGPosition,n),gNormal=texture(texGNormal,n),gAlbedo=texture(texGAlbedo,n),gDepth=t,gParam_1=texture(texParam1,n),outColor=texture(texMainColor,n);else{vec4 t=texture(texSSWGPosition,n),g=texture(texSSWGNormal,n),c=texture(texSSWGAlbedo,n),l=texture(texSSWParam1,n);gPosition=t;gNormal=g;gAlbedo=c;gDepth=z;gParam_1=l;vec3 s=g.xyz,b=c.xyz,r=t.xyz;bool a=floor(l.y)==1.,h=floor(l.y)==2.;vec3 o=-1.f*normalize(vec3(0,-1,-1)),v=vec3(0);if(a)v+=e(b,s,r,true,false,o);for(float l=-1.;l<=1.;l++)o=-1.f*normalize(vec3(0,-1,-1)),o.xz*=rot(l*acos(-1.)*(1./6.)),v+=e(b,s,r,false,h,o);{vec3 u=t.xyz,f=fragUBO.cameraPos.xyz,d=normalize(u-f);f=refract(d,s,1./1.33);float i=10./24.;vec3 m=f*i,N=u,P=vec3(0);vec2 O=vec2(0);for(float l=0.;l<24.;l++){N+=m;vec4 t=fragUBO.proj*fragUBO.view*vec4(N,1);O=t.xy/t.w*.5+.5;vec3 u=texture(texGPosition,O).xyz;if(length(u-N)<.5){P=texture(texMainColor,O).xyz;break;}}if(O.x<0.||O.x>1.||O.y<0.||O.y>1.){N=u;f=d;m=f*i;for(float l=0.;l<24.;l++){N+=m;vec4 t=fragUBO.proj*fragUBO.view*vec4(N,1);O=t.xy/t.w*.5+.5;vec3 u=texture(texGPosition,O).xyz;if(length(u-N)<.5){P=texture(texMainColor,O).xyz;break;}}}v+=P;}outColor=vec4(v,1);}}