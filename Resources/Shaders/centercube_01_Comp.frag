#version 450
layout(location=0) in vec4 v2f_ObjectPos;layout(location=1) in vec2 v2f_UV;layout(location=0) out vec4 gPosition;layout(location=1) out vec4 gNormal;layout(location=2) out vec4 gAlbedo;layout(location=3) out vec4 gDepth;layout(location=4) out vec4 gParam_1;
#define repeat(p,a)mod(p,a)-a*0.5
#define rot(a)mat2(cos(a),sin(a),-sin(a),cos(a))
#define pi acos(-1.0)
#define pi2 pi*2.0
struct MatInfo{float d;float MatID;float metallic;float roughness;};MatInfo t(MatInfo o,float v,float r){if(v<o.d)o.d=v,o.MatID=r,o.metallic=.25,o.roughness=1.;return o;}float t(vec3 o,vec2 v){return length(vec2(length(o.xz)-v.x,o.y))-v.y;}MatInfo t(vec3 v){MatInfo o;o.d=1e5;o.MatID=-1;o.metallic=0.;o.roughness=0.;float a=fragUbo.time*.1;{vec3 f=v;f.xy*=rot(-a);f.yz*=rot(-a);f.xz*=rot(-a);f.xy*=rot(pi*.25);float n=t(f,vec2(2.5,.025));o=t(o,n,3.);}{vec3 f=v;f.xy*=rot(a);f.yz*=rot(a);f.xz*=rot(a);f.xy*=rot(pi*-.25);float n=t(f,vec2(2,.025));o=t(o,n,3.);}{vec3 f=v;f.xy*=rot(-a);f.yz*=rot(a);f.xz*=rot(-a);f=abs(f);float r=1.,n=fragUbo.tparam*3.1415*2.;for(int o=0;o<5;o++){f=abs(f)-vec3(fragUbo.param0.w);if(f.x<f.y)f.xy=f.yx;if(f.x<f.z)f.xz=f.zx;if(f.y<f.z)f.yz=f.zy;float d=clamp(max(0.,2./dot(v,v)),0.,2.);f*=d;r*=d;f.xy-=.2;f.xy*=rot(fragUbo.param0.x*n);f.yz*=rot(fragUbo.param0.y*n);f.xz*=rot(fragUbo.param0.z*n);}f/=r;r=t(f,vec2(.5,.05));o=t(o,r,3.);}return t(o,length(v)-.5,4.);}vec3 r(vec3 a){vec2 o=vec2(.001,0);return normalize(vec3(t(a+o.xyy).d-t(a-o.xyy).d,t(a+o.yxy).d-t(a-o.yxy).d,t(a+o.yyx).d-t(a-o.yyx).d));}float v(vec3 a){vec4 o=fragUbo.proj*fragUbo.view*vec4(a,1);float f=o.z/o.w*.5+.5,v=f*f,n=dFdx(f);f=dFdy(f);return v+.25*(n*n+f*f);}void main(){vec3 f=vec3(0);vec2 o=v2f_UV*2.-1.;o.x*=fragUbo.resolution.x/fragUbo.resolution.y;vec3 a=(fragUbo.invModel*fragUbo.cameraPos).xyz,n=normalize(v2f_ObjectPos.xyz-a);a+=fragUbo.cameraPos.xyz;float d=0.;vec3 l=a+n*d;MatInfo g;g.d=1e5;g.MatID=-1;g.metallic=0.;g.roughness=0.;for(int f=0;f<64;f++){g=t(l);d+=g.d*.5;l=a+n*d;if(abs(g.d)<.001)break;}if(g.d<.001){vec3 o=r(l);float a=v(l);f=fragUbo.mainColor.xyz;if(g.MatID==4.)f=vec3(2);gPosition=vec4(l,1);gNormal=vec4(o,1);gAlbedo=vec4(f,1);gDepth=vec4(vec3(a),1);gParam_1=vec4(g.MatID,fragUbo.LightParam,g.metallic,g.roughness);gl_FragDepth=a;}else discard;}